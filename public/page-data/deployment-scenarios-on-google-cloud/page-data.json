{"componentChunkName":"component---src-templates-post-js","path":"/deployment-scenarios-on-google-cloud/","result":{"data":{"markdownRemark":{"html":"<p>In this article I am going to go through different deployments scenarios on Google Cloud:</p>\n<ol>\n<li>Deploy your own Docker image for your Vertex.ai pipelines</li>\n<li>Deploy your own private python library from Bitbucket</li>\n</ol>\n<p>For the first scenario we will first quickly describe the Vertex AI pipeline service. Next we will demonstrate how to use some simple commands to build and push your custom docker images to be ready to use by your own Vertex.ai pipeline components. For the last scenario, will we will first describe how to use and configure Bitbucket pipelines to achive our goals. Then we'll dive into the specifities of the subject. If you want to implement these, the article assumes you already have a google cloud account with the required rights and permissions.</p>\n<h2 id=\"vertexai\" style=\"position:relative;\"><a href=\"#vertexai\" aria-label=\"vertexai permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Vertex.ai</h2>\n<p><a href=\"https://cloud.google.com/vertex-ai?hl=us\">Vertex.ai</a> is a Google Cloud service that enables the user to build, deploy, and scale data pipelines and machine learning models. It includes some services to track and manage model artifacts, performances and metrics.\nGoogle provide a <a href=\"https://cloud.google.com/vertex-ai/docs/start/use-vertex-ai-python-sdk\">Python SDK</a> that permits the user to interact directly with the different services.</p>\n<p>Vertex AI pipeline is a service that allows you to orchestrate different step of a data pipeline. Each step of the pipeline is an autonomous piece of code that will be executed in its own container. Each of these steps can accept inputs and generate outputs for downstream steps. Altogether the steps define a workflow that can be represented as an acyclic graph.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/f4801f88256f9bf9569609d1acbf8b82/29114/Vertexai.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABx0lEQVR42o2S62oVMRSF5/3BHwq1VKX4DiLUSrWKLyJUpOecuSU72bl/kjmnFSwUA4vMZF+y1l4ZLm4OXH6beP/DcnZ94MWHXxtefrzj/OqO8+vfvL25593twvnNwsWXkbPPC29uDRdfV15d7Xl9vePy+8rZp58MVAECx5UABSI0D01PZ+UUbyfw9z87gsyn/MiwmwOLZHxs5FKRUJlWhzhl8oZRAsvqmI3l3i7MNrIYYRFhVsFah8aEeEWcZ3BeiSlTSqXWSimFGBPeRUrJ5FJQTXifyCVvce8SMWZqq4gI3ivrurIsC4MxK/v9jpwzrVVSLmgIOKdI6EhYUZz3rKpYnxHxePWEHMkpb7XWWowxDGZdsSK01mi1orGwGo/3gUkMqwsY61iNZXYG6yKmS7YGl5RpnE4s/bYPIpYQjqZ02XSWsZJzJWo5jiAVcqqbB30sMRRqPZrTmfX68XBgv98zOJFNf098QDdnNIqxlsl2YwyltG0c/dJSjxd1VV1mb2rlqGTw3j1p+GDO43ct2zj+zemrG7Hb7fAaUQ0MD8Fthq09KXoOPb+T6Qy9c4zjyJBS2p5GD6rqo5T/bTjPC/M8E1SZpok/st5OdqV4u8UAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"Vertexai\" title=\"Vertexai\" src=\"/static/f4801f88256f9bf9569609d1acbf8b82/a6d36/Vertexai.png\" srcset=\"/static/f4801f88256f9bf9569609d1acbf8b82/222b7/Vertexai.png 163w,\n/static/f4801f88256f9bf9569609d1acbf8b82/ff46a/Vertexai.png 325w,\n/static/f4801f88256f9bf9569609d1acbf8b82/a6d36/Vertexai.png 650w,\n/static/f4801f88256f9bf9569609d1acbf8b82/e548f/Vertexai.png 975w,\n/static/f4801f88256f9bf9569609d1acbf8b82/3c492/Vertexai.png 1300w,\n/static/f4801f88256f9bf9569609d1acbf8b82/29114/Vertexai.png 1920w\" sizes=\"(max-width: 650px) 100vw, 650px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span></p>\n<p><em>Figure 1</em> : Example of a vertex ai pipeline</p>\n<h2 id=\"choose-your-container-image-for-your-vertex-component\" style=\"position:relative;\"><a href=\"#choose-your-container-image-for-your-vertex-component\" aria-label=\"choose your container image for your vertex component permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Choose your container image for your Vertex component</h2>\n<p>For the implementation of the components and the compilation of the pipeline, I am using the Kubeflow SDK. A typical components can be implemented as followed.</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"python\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">from</span><span class=\"mtk1\"> kfp.v2.dsl </span><span class=\"mtk3\">import</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Input,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">@component</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">packages_to_install</span><span class=\"mtk1\">=[</span><span class=\"mtk7\">&quot;put&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;here&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;librairies&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;to&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;install&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">base_image</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;the docker image to use&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">output_component_file</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;predict.yaml&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">predict</span><span class=\"mtk1\">(</span><span class=\"mtk9\">data</span><span class=\"mtk1\">: Input[Dataset]):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- imports</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Import your modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Helpers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implemenent helpers functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># add any local variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Component execution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implement the logic of your component</span></span></span></code></pre>\n<p>I will describe in a different article the nults and bolts of components and pipelines in Kubeflow and give you some tricks about it.\nHere we are going to focus on the <code>base_image</code>. By default you can use some already available container. If you want to use python <code>3.9</code> as your environment, you just need to specify it in the <code>@component()</code> decorator.</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"python\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">from</span><span class=\"mtk1\"> kfp.v2.dsl </span><span class=\"mtk3\">import</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Input,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">@component</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">packages_to_install</span><span class=\"mtk1\">=[</span><span class=\"mtk7\">&quot;put&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;here&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;librairies&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;to&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;install&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">base_image</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;python:3.9&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">output_component_file</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;predict.yaml&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">predict</span><span class=\"mtk1\">(</span><span class=\"mtk9\">data</span><span class=\"mtk1\">: Input[Dataset]):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- imports</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Import your modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Helpers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implemenent helpers functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># add any local variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Component execution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implement the logic of your component</span></span></span></code></pre>\n<p>Similarly, any library you want to install without specifying its version can be added there:</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"python\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">from</span><span class=\"mtk1\"> kfp.v2.dsl </span><span class=\"mtk3\">import</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Input,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">@component</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">packages_to_install</span><span class=\"mtk1\">=[</span><span class=\"mtk7\">&quot;pandas&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;numpy&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;matplotlib&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">base_image</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;python:3.9&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">output_component_file</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;predict.yaml&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">predict</span><span class=\"mtk1\">(</span><span class=\"mtk9\">data</span><span class=\"mtk1\">: Input[Dataset]):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- imports</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Import your modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Helpers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implemenent helpers functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># add any local variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Component execution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implement the logic of your component</span></span></span></code></pre>\n<p>Now you may face a scenario where you need to bring your own environment. For that, you will need to use your own container image. For the desmontration, let's imagine that I want to use python <code>3.10</code> and XGBoost <code>v1.3.3</code> for my predictions. To make this environment ready to use for my component I need to:</p>\n<ol>\n<li>Define the docker file</li>\n<li>Build and push the container on Google Cloud</li>\n<li>Point to this container uusing the <code>base_image</code> parameter present in <code>@component</code></li>\n</ol>\n<p>A typical <code>Dockerfile</code> would look like the following</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"dockerfile\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">FROM</span><span class=\"mtk1\"> python:3.10.7-slim-buster</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4 mtki\"># Remove any third-party apt sources to avoid issues with expiring keys.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> rm -f /etc/apt/sources.list.d/*.list</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4 mtki\"># Install dependencies for python build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\">    apt-get update \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; apt-get install --no-install-recommends -qqy \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gcc \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gfortran \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        curl \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        ca-certificates \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        sudo \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        openssh-client \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        git \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        bzip2 \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        libx11-6 \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; apt-get clean</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> python3 -m pip install --upgrade pip \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; pip install xgboost==1.3.3 \\</span></span></span></code></pre>\n<p>Now we can first build the image and tag it with the following command.</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"bash\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker build </span><span class=\"mtk8\">.</span><span class=\"mtk1\"> --file ai_vertex/Dockerfile --tag vertex</span></span></span></code></pre>\n<blockquote>\n<p><strong><em>Note:</em></strong> if you are a Mac M1/M2 user. you should use the following build command <code>docker buildx build . --file train/Dockerfile --platform linux/amd64 --tag train</code></p>\n</blockquote>\n<p>Next we need to use a specific tag that will be the path where the image will be located on Google Cloud. Our images are stored in <a href=\"https://cloud.google.com/container-registry\">Google Clound Container Registry</a>. So we run:</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"bash\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker tag vertex </span><span class=\"mtk7\">&quot;eu.gcr.io/&lt;YOUR_PORJECT&gt;/&lt;PARENT...&gt;/&lt;IMAGE_NAME_TAG&gt;&quot;</span></span></span></code></pre>\n<blockquote>\n<p><strong><em>Note:</em></strong>  We are located in Europe. So the adress name starts with <code>eu</code>. Use the right naming convention according to your location.</p>\n</blockquote>\n<p>We need to enable Docker to authenticate to Container Registry.  For that execute the following command:</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"bash\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">gcloud auth configure-docker</span></span></span></code></pre>\n<blockquote>\n<p><strong><em>Note:</em></strong>  This command creates the Docker <code>credHelper</code> entry to your Docker's configuration file, or creates the file if it doesn't exist. It can be achieved in any environment where the Google Cloud CLI and Docker are installed.</p>\n</blockquote>\n<p>Finally we can push our image to our registry.</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"bash\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">docker push </span><span class=\"mtk7\">&quot;eu.gcr.io/&lt;YOUR_PORJECT&gt;/&lt;PARENT...&gt;/&lt;IMAGE_NAME_TAG&gt;&quot;</span></span></span></code></pre>\n<p>Now in our component we can point to the right image:</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"python\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">from</span><span class=\"mtk1\"> kfp.v2.dsl </span><span class=\"mtk3\">import</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Dataset,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    Input,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">@component</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">packages_to_install</span><span class=\"mtk1\">=[</span><span class=\"mtk7\">&quot;pandas&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;numpy&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk7\">&quot;matplotlib&quot;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">base_image</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;eu.gcr.io/&lt;YOUR_PORJECT&gt;/&lt;PARENT...&gt;/&lt;IMAGE_NAME_TAG&gt;&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk9\">output_component_file</span><span class=\"mtk1\">=</span><span class=\"mtk7\">&quot;predict.yaml&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk5\">def</span><span class=\"mtk1\"> </span><span class=\"mtk8\">predict</span><span class=\"mtk1\">(</span><span class=\"mtk9\">data</span><span class=\"mtk1\">: Input[Dataset]):</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- imports</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Import your modules</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Helpers</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implemenent helpers functions</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># add any local variable</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># ---- Component execution</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># Implement the logic of your component</span></span></span></code></pre>\n<p>Because I do not manage tons of custom docker images and because we do not update these environments that often, you can manage the updates manually. My advice is to encapsulate all the command into a <code>Makefile</code> to sequentially execute all steps described above.\nWith this in mind you can now use any custom docker images and bring any environments you want to use for Vertex components.</p>\n<h2 id=\"bitbucket-pipelines\" style=\"position:relative;\"><a href=\"#bitbucket-pipelines\" aria-label=\"bitbucket pipelines permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bitbucket Pipelines</h2>\n<p>Bitbucket Pipelines is an integrated Continuous Integration and Development service, built into Bitbucket. It is very similar to what proposes Github with Github actions. It allows users to automatically build, test and even deploy your code based on a <code>yaml</code> configuration file in your repository. Briefly, Bitbucket pipelines spins up container based on your configuration and execute the command you want. It is particularly interesting to use Bitbucket pipelines to test your code after each push.</p>\n<p>In our context (deployment of containers and code on google cloud), a typical bibucket-pipelines.yml` file looks like this:</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"yaml\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk10\">image</span><span class=\"mtk1\">: </span><span class=\"mtk7\">google/cloud-sdk</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">pipelines</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">default</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk10\">step</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">name</span><span class=\"mtk1\">: </span><span class=\"mtk7\">Build, authenticate and test</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">script</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">Command_1</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">Command_2</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">Command_3</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">docker</span></span></span></code></pre>\n<p>With this configuration files you can specify:</p>\n<ul>\n<li>The docker image you want to use.</li>\n<li>The commands you want to run.</li>\n<li>The services that need to be activated.</li>\n</ul>\n<p>Let's postulate that we have some code that we want to push to our remote repository. This code contains unit and integrations test that require the use of some google cloud services. The <code>Dockerfile</code> can be implemented as followed:</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"dockerfile\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">FROM</span><span class=\"mtk1\"> python:3.10.7-slim-buster </span><span class=\"mtk6\">as</span><span class=\"mtk1\"> base-env</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">WORKDIR</span><span class=\"mtk1\"> /opt/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">COPY</span><span class=\"mtk1\"> . .</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4 mtki\"># Install dependencies for python build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\">    apt-get update \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; apt-get install --no-install-recommends -qqy \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gcc \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gfortran \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; apt-get clean \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># &amp;&amp; rm -rf /var/lib/apt/lists/* \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> pip install --upgrade pip</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> python3 -m pip install --upgrade pip \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; pip install --no-cache-dir -r requirements-dev.txt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> coverage run --source . -m pytest &amp;&amp; coverage report --skip-empty  --omit </span><span class=\"mtk7\">&quot;tests/*&quot;</span><span class=\"mtk1\">  -m</span></span></span></code></pre>\n<p>Next we can specify the command to build our testing image in our <code>bibucket-pipelines.yaml</code> file.</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"yaml\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">image</span><span class=\"mtk1\">: </span><span class=\"mtk7\">google/cloud-sdk</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">pipelines</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">default</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk10\">step</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">name</span><span class=\"mtk1\">: </span><span class=\"mtk7\">Build, authenticate and test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">script</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">docker build . -f YOUR_DOCKERFILE</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">docker</span></span></span></code></pre>\n<p>If push your code now, it is very likely that the bitbucket pipeline would crash with some google cloud authentication error. How can we pass credentials? You first need to create a service account for bitbucket. Give it the needed rights and permissions. Next create your keyfile. It is a json file that contains all required authentication details</p>\n<pre class=\"grvsc-container panda-syntax\" data-language=\"json\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">{</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;type&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;service_account&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;project_id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;project_name&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;private_key_id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;blablablablabla&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;private_key&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;-----BEGIN PRIVATE KEY-----</span><span class=\"mtk6\">\\n</span><span class=\"mtk7\">-----END PRIVATE KEY-----</span><span class=\"mtk6\">\\n</span><span class=\"mtk7\">&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;client_email&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;email_of_the_user_or_service_account&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;client_id&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;id_id_id_client&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;auth_uri&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;google oauth2/auth link&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;token_uri&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;your_token&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;auth_provider_x509_cert_url&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;link to certificate&quot;</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">&quot;client_x509_cert_url&quot;</span><span class=\"mtk1\">: </span><span class=\"mtk7\">&quot;the certificate from the service account&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Keep this file on your computer and do not version it. To pass the credential to your pipeline you'ill need to create or ask your admin to create a [repository variable](Repository settings > Pipelines > Repository variables). Name this variable, for example <code>GCP_AUTH_BASE64</code> and paste the encoded content of your keyfile as value. Keep it secured and encrypted on Bitbucket side. Once this is done, you can use the repostiory variable.</p>\n<blockquote>\n<blockquote>\n<p><strong><em>Note:</em></strong>  Be careful when you copy/paste the file content. It may contain spaces that bitbucket cannot handle. A tip for that is to set <code>--wraps=0</code> when you use the <code>base64</code> command. This will output one line of data without any unexpected` space.</p>\n</blockquote>\n</blockquote>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"yaml\" data-index=\"13\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">---</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">image</span><span class=\"mtk1\">: </span><span class=\"mtk7\">google/cloud-sdk</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk10\">pipelines</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk10\">default</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    - </span><span class=\"mtk10\">step</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">name</span><span class=\"mtk1\">: </span><span class=\"mtk7\">Build, authenticate and test</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">script</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">docker build . -f YOUR_DOCKERFILE --build-arg GCP_AUTH=&quot;${GCP_AUTH_BASE64}&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk10\">services</span><span class=\"mtk1\">:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          - </span><span class=\"mtk7\">docker</span></span></span></code></pre>\n<p>We build an argument with Docker that is going to pass the value hold by the repository variable <code>GCP_AUTH_BASE64</code>. To work we need to modify our <code>Dockerfile</code>.</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting panda-syntax\" data-language=\"dockerfile\" data-index=\"14\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">FROM</span><span class=\"mtk1\"> python:3.10.7-slim-buster </span><span class=\"mtk6\">as</span><span class=\"mtk1\"> base-env</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">WORKDIR</span><span class=\"mtk1\"> /opt/app</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">COPY</span><span class=\"mtk1\"> . .</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4 mtki\"># Install dependencies for python build</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\">    apt-get update \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; apt-get install --no-install-recommends -qqy \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gcc \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        gfortran \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; apt-get clean \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4 mtki\"># &amp;&amp; rm -rf /var/lib/apt/lists/* \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> pip install --upgrade pip</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk6\">ARG</span><span class=\"mtk1\"> GCP_AUTH</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> echo </span><span class=\"mtk7\">&quot;${GCP_AUTH}&quot;</span><span class=\"mtk1\"> | base64 -d &gt;&gt; /tmp/key-file.json</span></span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\"><span class=\"mtk6\">ARG</span><span class=\"mtk1\"> export GOOGLE_APPLICATION_CREDENTIALS=</span><span class=\"mtk7\">&quot;/tmp/key-file.json&quot;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> python3 -m pip install --upgrade pip \\</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &amp;&amp; pip install --no-cache-dir -r requirements-dev.txt</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk6\">RUN</span><span class=\"mtk1\"> coverage run --source . -m pytest &amp;&amp; coverage report --skip-empty  --omit </span><span class=\"mtk7\">&quot;tests/*&quot;</span><span class=\"mtk1\">  -m</span></span></span></code></pre>\n<p>Notice how we deal with the argument <code>GCP_AUTH</code>. Its value is decoded and save into a temporary file. We assign its path to the <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable. Now each time you code need to reach some google cloud services, it will find the necessary credentials to accomplish its task.</p>\n<p>This part is extremely important if you want to streamline and automate your deployment / interaction with google cloud services</p>\n<h2 id=\"deploy-your-own-python-library-on-google-artifact\" style=\"position:relative;\"><a href=\"#deploy-your-own-python-library-on-google-artifact\" aria-label=\"deploy your own python library on google artifact permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy your own python library on Google Artifact</h2>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .panda-syntax {\n    background-color: #292A2B;\n    color: #E6E6E6;\n  }\n  .panda-syntax .mtki { font-style: italic; }\n  .panda-syntax .mtk3 { color: #FF75B5; }\n  .panda-syntax .mtk1 { color: #E6E6E6; }\n  .panda-syntax .mtk8 { color: #6FC1FF; }\n  .panda-syntax .mtk9 { color: #BBBBBB; }\n  .panda-syntax .mtk7 { color: #19F9D8; }\n  .panda-syntax .mtk5 { color: #FFB86C; }\n  .panda-syntax .mtk4 { color: #676B79; }\n  .panda-syntax .mtk6 { color: #45A9F9; }\n  .panda-syntax .mtk10 { color: #FFCC95; }\n  .panda-syntax .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Deployment scenarios on google cloud","date":"06 January, 2023","tags":["Python","Google"]},"excerpt":"In this article I am going to go through different deployments scenarios on Google Cloud: Deploy your own Docker image for your Vertex.ai…"}},"pageContext":{"slug":"/deployment-scenarios-on-google-cloud/"}},"staticQueryHashes":["3649515864","63159454"],"slicesMap":{}}