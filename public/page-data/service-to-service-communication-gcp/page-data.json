{"componentChunkName":"component---src-pages-markdown-remark-fields-slug-js","path":"/service-to-service-communication-gcp/","result":{"data":{"markdownRemark":{"html":"<p>At my work we process our data using Google Cloud services. For different use cases, we mainly use Cloud functions to process files and Cloud Run services to generate features, sleep scores and predictions. We use PubSub to trigger our cloud functions and, Cloud Task or Scheduler to trigger our respective Cloud Run services. All of them use HTTP requests to communicate with each others. By default, communication with Cloud run services requires authentication. Here, I am going to present how to set up authenticated communications with google Cloud Run services.</p>\n<h2 id=\"our-data-flow\" style=\"position:relative;\"><a href=\"#our-data-flow\" aria-label=\"our data flow permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Our data flow</h2>\n<p>In our data infrastructure we use a Scheduler that pings one of our Cloud Run service that we call the <code>poller</code>. The role of the <code>poller</code> is, once triggered, to scan a Google Cloud bucket where are stored our new data. If new data is found, it sends the necessary metadata to another Cloud Run service, called the <code>worker</code>. The <code>worker</code> will then process the data. If the processing succeeds or fails the <code>worker</code> sends back an HTTP message (HTTP code <code>200</code> or <code>500</code>) that prompts the <code>poller</code> to move the processed file to the required bucket.</p>\n<h2 id=\"scheduler-to-cloud-run\" style=\"position:relative;\"><a href=\"#scheduler-to-cloud-run\" aria-label=\"scheduler to cloud run permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scheduler to Cloud Run</h2>\n<p>Make Cloud Scheduler and Cloud run communicate with authentication is fairly easy. First you need to create a service account for your scheduler that will have the <code>roles/run.invoker</code> role. When creating your scheduler, configure the <code>Configure the execution</code> as showed below.</p>\n<p><span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 759px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/fbraza-github-pages/static/a5243bbe45ba1dc6ea7f995822712af0/ef3e1/2023-02-13-service-to-service-communication-gcp-figure-01.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 123.4375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADDklEQVR42qVV2U7bUBQMlXgrW5FAfAFfybfwD1RUAtEHkJICidoI8VIQ2TfiOLbjxHsyPXMjGxsTSlVLY1/f5fgsM8eF+QKYzTy02y00my10u110ez30BK1WE/1+H4uFbPrgVeDemePg+voHLi8v8fT0hI4YbTaaqNfqaHc6cF0XYRgiiuY5BEEoa9GLwfl8Dt/3xcuZOrTqopfcmwbnPM9TSAzyNp1OcXLyFaen33B2dobz83NcXHzPoNPpipGFfDxQXqWR8ZC3moR2eHiInZ0d7O/vY29vTz2Jg4MDbG5u4vj4WB0IgiDnaTqyQux2tVpFqVTC3d2dFKiNhuQwDUZBT157x7P0OpNDTk5s+91qci0Nhs/tzL8nyHjoSJW73Z7Kk66PEUaRCi0NesfQYrDC6eK8GJSbIxVmmM1GA4PBAKZpYjweK+OmaSTvfBqGYKzDsDzoZghjEmKeNqho4/mo1+tC4kHCL85H4im39uUjLNxkYiuDpoB584Olpxlixzy07Qn0kSbhMR+LFHkjVZDRSBcvDYx1XcYjlQau8XzOYBSFsOwQmhGi9+xioLnZIrxTpJz0aJBfsyzxQrek2p6oxk+SHVd0WdXVyPGQjeDh4bcUYpQj7irwLNPlp2kT51DTNAyHmuouruu9SeK85EhsP0vs2EO2rlqtJqpoCD0stbj0JA55noT9IQ+Hw6HqgaTO8/MQ1mQiebUU9/ikkmyhDaljS9UVZM5x3KyWVVEkvJkjEpK+x97nea7ayPF0OlPzlhjWhTKaUIbPoWah1bOFHcHrBkvpefj5qypN9hrlckVQRqVSSXB7e6sUtErTRKZ93d/fY3f3C9bX17GxsZHgs2Brextrn9ZwdHSkDjA9kdJ1lOg7VxSGxtZ1dXWFm5sbGRdRKhZRFs+KMl+U8ePjo+S4r1jAXPPfQxmy2ovXWuZXArYhb5k3dh/+EpKxgAWg5NgkVA8MqGVfyS+nlFCkZ88CjE1SIFSborhVcRxrdgH87QeYSG9kuGj3p3DcAP9zFV60uMS//IPfuv4Anrhh/zycweUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"scheduler-auth.png\" title=\"Configure Scheduler\" src=\"/fbraza-github-pages/static/a5243bbe45ba1dc6ea7f995822712af0/ef3e1/2023-02-13-service-to-service-communication-gcp-figure-01.png\" srcset=\"/fbraza-github-pages/static/a5243bbe45ba1dc6ea7f995822712af0/6f3f2/2023-02-13-service-to-service-communication-gcp-figure-01.png 256w,\n/fbraza-github-pages/static/a5243bbe45ba1dc6ea7f995822712af0/01e7c/2023-02-13-service-to-service-communication-gcp-figure-01.png 512w,\n/fbraza-github-pages/static/a5243bbe45ba1dc6ea7f995822712af0/ef3e1/2023-02-13-service-to-service-communication-gcp-figure-01.png 759w\" sizes=\"(max-width: 759px) 100vw, 759px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n  </a>\n    </span></p>\n<p>Note the Google-signed OpenID Connect (OIDC) token passed in the header of the request. It is a token signed by google that allows the scheduler to communicate with other services in a authenticated way. Two other services can automatically include an ID token, Cloud Task and Pub/Sub.</p>\n<h2 id=\"cloud-run-to-cloud-run\" style=\"position:relative;\"><a href=\"#cloud-run-to-cloud-run\" aria-label=\"cloud run to cloud run permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Run to Cloud Run</h2>\n<p>The approach is a bit different for communication between two cloud run services. First, attach to the sender a service account with the <code>roles/run.invoker</code> role. Next, you need to write a little bit of code in your request. Our poller, list files and send their path to the worker so that it can upload the data and process it. In the request code we need to add some lines to authenticate:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">whatever_function_used_for_request</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Code for authentication</span>\n    http <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>Session<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    auth_req <span class=\"token operator\">=</span> google<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>transport<span class=\"token punctuation\">.</span>requests<span class=\"token punctuation\">.</span>Request<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    audience <span class=\"token operator\">=</span> os<span class=\"token punctuation\">.</span>environ<span class=\"token punctuation\">[</span><span class=\"token string\">\"worker_url\"</span><span class=\"token punctuation\">]</span>\n    id_token <span class=\"token operator\">=</span> google<span class=\"token punctuation\">.</span>oauth2<span class=\"token punctuation\">.</span>id_token<span class=\"token punctuation\">.</span>fetch_id_token<span class=\"token punctuation\">(</span>auth_req<span class=\"token punctuation\">,</span> audience<span class=\"token punctuation\">)</span>\n    headers <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"Bearer </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>id_token<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">}</span>\n    response <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> json<span class=\"token operator\">=</span>json_dict<span class=\"token punctuation\">,</span> headers<span class=\"token operator\">=</span>headers<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The interesting line of code is the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">id_token <span class=\"token operator\">=</span> google<span class=\"token punctuation\">.</span>oauth2<span class=\"token punctuation\">.</span>id_token<span class=\"token punctuation\">.</span>fetch_id_token<span class=\"token punctuation\">(</span>auth_req<span class=\"token punctuation\">,</span> audiance<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The function <code>fetch_id_token</code> acquires ID token from your environment in the following order:</p>\n<ol>\n<li>If the environment variable <code>GOOGLE_APPLICATION_CREDENTIALS</code> is set to the path of a valid service account <code>JSON</code> file, then ID token is acquired using this service account credentials.</li>\n<li>If the application is running in <code>Compute Engine</code>, <code>App Engine</code> or <code>Cloud Run</code>, then the ID token is obtained from the metadata server.</li>\n<li>If metadata server doesn't exist and no valid service account credentials are found, it raise the <code>google.auth.exceptions DefaultCredentialsError</code> error.</li>\n</ol>\n<h2 id=\"wrap-up\" style=\"position:relative;\"><a href=\"#wrap-up\" aria-label=\"wrap up permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wrap-up</h2>\n<p>And that's it. Keeping authenticated communication is very important to secure your infrastructure. Making cloud services communicate between them is fairly easy but not always clearly documented online, even in the official documentation that is sometimes too verbose. I decided to digest what i learnt in this process and provide the reader this short guide.</p>","frontmatter":{"title":"Service to service communication in Google Cloud","date":"February 13, 2023","tags":["Google Cloud"]}}},"pageContext":{"id":"f37126fb-85db-54ca-a4a5-14f4484ef533","fields__slug":"/service-to-service-communication-gcp/","__params":{"fields__slug":"service-to-service-communication-gcp"}}},"staticQueryHashes":["2750728228"],"slicesMap":{}}